<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>LineFlow Creator - Offset Zentangle</n
    <script src="https://unpkg.com/paper@0.12.15/dist/paper-full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin:0; padding:0; overflow:hidden; }
        #tools { position:fixed; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:10px; border-radius:6px; z-index:10; }
        #tools * { margin:4px; }
        canvas { width:100vw; height:100vh; display:block; }
    </style>
</head>
<body>
<div id="tools">
    <button onclick="undo()">Voltar</button>
    <select id="thickness" onchange="changeThickness()">
        <option value="1">1px</option>
        <option value="2" selected>2px</option>
        <option value="3">3px</option>
        <option value="4">4px</option>
        <option value="5">5px</option>
    </select>
    <input type="color" id="colorPicker" value="#800080" title="Cor do traço">
    <input type="color" id="bgPicker" value="#ffffff" onchange="changeBG()" title="Cor do fundo">
    <button onclick="exportPNG()">Exportar PNG</button>
    <button onclick="exportPDF()">Exportar PDF</button>
</div>
<canvas id="myCanvas" resize></canvas>
<script>
    paper.setup('myCanvas');
    const canvasElem = document.getElementById('myCanvas');
    let masterPath, clones = [];
    let isDrawing = false;

    // Undo setup
    paper.project.installPlugins(paper.Undo);

    function onMouseDown(event) {
        // Iniciar novo traço mestre
        masterPath = new paper.Path({
            strokeColor: document.getElementById('colorPicker').value,
            strokeWidth: parseInt(document.getElementById('thickness').value)
        });
        isDrawing = true;
    }

    function onMouseDrag(event) {
        if (!isDrawing) return;
        masterPath.add(event.point);
    }

    function onMouseUp(event) {
        if (!isDrawing) return;
        isDrawing = false;
        // Suavizar e simplificar
        masterPath.simplify(8);
        masterPath.smooth({ type: 'continuous' });

        // Criar offsets paralelos
        const steps = 12; // quantos clones
        const spacing = 10; // distância entre clones
        const normal = masterPath.getNormalAt(masterPath.length / 2).normalize();
        clones = [];
        for (let i = 1; i <= steps; i++) {
            let clone = masterPath.clone();
            clone.strokeColor = masterPath.strokeColor;
            clone.strokeWidth = masterPath.strokeWidth;
            clone.translate(normal.multiply(spacing * i));
            clones.push(clone);
        }
    }

    function undo() {
        paper.project.undo();
    }

    function changeThickness() {
        // Ajuste para futuros traços
    }

    function changeBG() {
        canvasElem.style.backgroundColor = document.getElementById('bgPicker').value;
    }

    async function exportPNG() {
        const dataURL = canvasElem.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = 'zentangle-offset.png';
        link.href = dataURL;
        link.click();
    }

    async function exportPDF() {
        const canvasImg = await html2canvas(canvasElem);
        const imgData = canvasImg.toDataURL('image/png');
        const pdf = new jspdf.jsPDF({ orientation:'landscape', unit:'px', format:[canvasElem.width, canvasElem.height] });
        pdf.addImage(imgData,'PNG',0,0,canvasElem.width, canvasElem.height);
        pdf.save('zentangle-offset.pdf');
    }

    paper.view.onMouseDown = onMouseDown;
    paper.view.onMouseDrag = onMouseDrag;
    paper.view.onMouseUp = onMouseUp;
</script>
</body>
</html>
