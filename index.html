<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>LineFlow Creator - Módulos S</title>
    <script src="https://unpkg.com/paper@0.12.15/dist/paper-full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #tools {
            position: fixed; top: 10px; left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px; border-radius: 8px; z-index: 10;
        }
        #tools button, #tools select, #tools input[type=color] {
            margin: 4px;
        }
        canvas { width: 100vw; height: 100vh; display: block; }
    </style>
</head>
<body>
<div id="tools">
    <button onclick="undo()">Voltar</button>
    <select id="thickness" onchange="changeThickness()">
        <option value="1">1px</option>
        <option value="2" selected>2px</option>
        <option value="3">3px</option>
        <option value="4">4px</option>
        <option value="5">5px</option>
    </select>
    <input type="color" id="colorPicker" value="#FF0080" title="Cor do traço">
    <input type="color" id="bgPicker" value="#ffffff" onchange="changeBG()" title="Cor do fundo">
    <button onclick="exportPNG()">Exportar PNG</button>
    <button onclick="exportPDF()">Exportar PDF</button>
</div>
<canvas id="myCanvas" resize></canvas>

<script>
    paper.setup('myCanvas');
    const canvasElem = document.getElementById('myCanvas');
    let currentGroup = null;
    let lastPoint = null;
    let isCmdDown = false;

    const segmentLength = 40;
    const amplitude = 12;

    document.addEventListener('keydown', e => {
        if (e.metaKey || e.ctrlKey) {
            isCmdDown = true;
            if (e.key.toLowerCase() === 'z') {
                undo(); e.preventDefault();
            }
        }
    });
    document.addEventListener('keyup', () => isCmdDown = false);

    function onMouseDown(event) {
        // Inicia novo grupo de módulos
        currentGroup = new paper.Group();
        currentGroup.strokeColor = document.getElementById('colorPicker').value;
        currentGroup.strokeWidth = parseInt(document.getElementById('thickness').value);
        lastPoint = event.point;
    }

    function onMouseDrag(event) {
        if (!currentGroup || isCmdDown) return;
        let pt = event.point;
        let delta = pt.subtract(lastPoint);
        let dist = delta.length;
        if (dist >= segmentLength) {
            let angle = delta.angle;
            // Criar um módulo S
            let seg = new paper.Path();
            seg.add(new paper.Point(0,0));
            seg.add(new paper.Point(segmentLength*0.25, amplitude));
            seg.add(new paper.Point(segmentLength*0.5, 0));
            seg.add(new paper.Point(segmentLength*0.75, -amplitude));
            seg.add(new paper.Point(segmentLength, 0));
            seg.strokeColor = currentGroup.strokeColor;
            seg.strokeWidth = currentGroup.strokeWidth;
            seg.rotate(angle);
            seg.translate(lastPoint);
            currentGroup.addChild(seg);
            lastPoint = lastPoint.add(delta.normalize(segmentLength));
        }
    }

    function onMouseUp(event) {
        // Finaliza grupo, nada adicional
        currentGroup = null;
    }

    function undo() {
        paper.project.undo();
    }

    function changeThickness() {
        // futura implementação por módulo
    }

    function changeBG() {
        canvasElem.style.backgroundColor = document.getElementById('bgPicker').value;
    }

    async function exportPNG() {
        const dataURL = canvasElem.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = 'zentangle-modular.png';
        link.href = dataURL;
        link.click();
    }

    async function exportPDF() {
        const canvasImg = await html2canvas(canvasElem);
        const imgData = canvasImg.toDataURL('image/png');
        const pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'px', format: [canvasElem.width, canvasElem.height] });
        pdf.addImage(imgData, 'PNG', 0, 0, canvasElem.width, canvasElem.height);
        pdf.save('zentangle-modular.pdf');
    }

    paper.view.onMouseDown = onMouseDown;
    paper.view.onMouseDrag = onMouseDrag;
    paper.view.onMouseUp   = onMouseUp;
</script>
</body>
</html>
